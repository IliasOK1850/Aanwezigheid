<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aanwezigheidsregistratie</title>
    <meta name="theme-color" content="#4a6fa5">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #2c3e50;
            --light-color: #f5f5f5;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            form {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        table tr:hover {
            background-color: #f1f1f1;
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-container input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .autocomplete {
            position: relative;
        }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid #ddd;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
        }
        
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        
        .autocomplete-active {
            background-color: var(--primary-color) !important;
            color: white;
        }
        
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        /* Checkbox styling */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        /* Responsive tweaks */
        /* Statistics styles */
        .stats-filters {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stats-card {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stats-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stats-chart {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            margin-top: 15px;
        }
        
        .chart-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .chart-label {
            width: 60px;
            text-align: right;
            padding-right: 10px;
            font-size: 0.9rem;
        }
        
        .chart-bar {
            flex-grow: 1;
            height: 25px;
            background-color: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .chart-bar-fill {
            height: 100%;
            background-color: var(--primary-color);
        }
        
        .chart-value {
            width: 40px;
            text-align: right;
            padding-left: 10px;
            font-weight: bold;
        }
        
        .pie-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .pie {
            width: 150px;
            height: 150px;
        }
        
        .pie-legend {
            flex-grow: 1;
            padding-left: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        .line-chart-container {
            margin-top: 15px;
            height: 200px;
        }
        
        .line-graph {
            width: 100%;
            height: 100%;
        }
        
        /* Print styles */
        @media print {
            .container {
                max-width: 100%;
                padding: 0;
            }
            
            header, .tabs, .tab-content:not(.active), .btn-group {
                display: none !important;
            }
            
            .tab-content.active {
                display: block !important;
            }
            
            .stats-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-charts {
                grid-template-columns: 1fr;
            }
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .stats-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-charts {
                grid-template-columns: 1fr;
            }
            
            .stats-filters {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .tab {
                padding: 10px;
                font-size: 14px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            table th, table td {
                padding: 8px;
                font-size: 14px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Aanwezigheidsregistratie</h1>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="register">Registreren</div>
            <div class="tab" data-tab="attendance">Aanwezigheidslijst</div>
            <div class="tab" data-tab="statistics">Statistieken</div>
            <div class="tab" data-tab="import">Importeren/Exporteren</div>
            <div class="tab" data-tab="settings">Instellingen</div>
        </div>
        
        <div id="register" class="tab-content active">
            <h2>Nieuwe aanwezigheid registreren</h2>
            <div class="search-container">
                <input type="text" id="personSearch" placeholder="Zoek bestaande persoon...">
                <div id="personSearchResults"></div>
            </div>
            
            <form id="registrationForm">
                <div class="form-group">
                    <label for="firstName">Voornaam</label>
                    <input type="text" id="firstName" required>
                </div>
                
                <div class="form-group">
                    <label for="age">Leeftijd</label>
                    <input type="number" id="age" min="0" max="120" required>
                </div>
                
                <div class="form-group">
                    <label for="gender">Geslacht</label>
                    <select id="gender" required>
                        <option value="">Selecteer geslacht</option>
                        <option value="M">Man</option>
                        <option value="V">Vrouw</option>
                        <option value="X">Ander/X</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="municipality">Gemeente</label>
                    <div class="autocomplete">
                        <input type="text" id="municipality" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="postalCode">Postcode</label>
                    <input type="text" id="postalCode" required>
                </div>
                
                <div class="form-group">
                    <label for="activity">Activiteit</label>
                    <input type="text" id="activity" required>
                </div>
                
                <div class="form-group">
                    <label for="theme">Thema</label>
                    <input type="text" id="theme" required>
                </div>
                
                <div class="form-group">
                    <label for="date">Datum</label>
                    <input type="date" id="date" required>
                </div>
                
                <div class="form-group" style="grid-column: span 2;">
                    <button type="submit" class="btn-block">Registreren</button>
                </div>
            </form>
        </div>
        
        <div id="attendance" class="tab-content">
            <h2>Aanwezigheidslijst</h2>
            <div class="search-container">
                <input type="text" id="attendanceSearch" placeholder="Zoeken...">
            </div>
            
            <table id="attendanceTable">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Naam</th>
                        <th>Leeftijd</th>
                        <th>Geslacht</th>
                        <th>Gemeente</th>
                        <th>Postcode</th>
                        <th>Activiteit</th>
                        <th>Thema</th>
                        <th>Acties</th>
                    </tr>
                </thead>
                <tbody id="attendanceList">
                    <!-- Data rows will be inserted here -->
                </tbody>
            </table>
        </div>
        
        <div id="import" class="tab-content">
            <h2>Gegevens importeren/exporteren</h2>
            
            <div class="file-upload">
                <h3>Importeer bestaande personen</h3>
                <p>Upload een CSV-bestand met bestaande personen. Het bestand moet de volgende kolommen bevatten: Naam, Leeftijd, Geslacht, Gemeente, Postcode</p>
                <input type="file" id="importPersonsFile" accept=".csv">
                <button id="importPersonsBtn" class="btn-warning">Importeren</button>
            </div>
            
            <div class="file-upload">
                <h3>Importeer gemeentelijst</h3>
                <p>Upload een CSV-bestand met Belgische gemeenten. Het bestand moet de volgende kolommen bevatten: Gemeente, Postcode</p>
                <input type="file" id="importMunicipalitiesFile" accept=".csv">
                <button id="importMunicipalitiesBtn" class="btn-warning">Importeren</button>
            </div>
            
            <div class="btn-group">
                <button id="exportBtn" class="btn-success">Exporteer aanwezigheden naar Excel</button>
            </div>
            
            <div id="importStatus" class="status-message"></div>
        </div>
        
        <div id="statistics" class="tab-content">
            <h2>Statistieken</h2>
            
            <div class="stats-filters">
                <div class="form-group">
                    <label for="statsDateFrom">Van</label>
                    <input type="date" id="statsDateFrom">
                </div>
                
                <div class="form-group">
                    <label for="statsDateTo">Tot</label>
                    <input type="date" id="statsDateTo">
                </div>
                
                <div class="form-group">
                    <button id="applyStatsFilter" class="btn-primary">Filter toepassen</button>
                </div>
            </div>
            
            <div class="stats-summary">
                <div class="stats-card">
                    <h3>Totale aanwezigheden</h3>
                    <div class="stats-value" id="totalAttendance">0</div>
                </div>
                
                <div class="stats-card">
                    <h3>Unieke bezoekers</h3>
                    <div class="stats-value" id="uniqueVisitors">0</div>
                </div>
                
                <div class="stats-card">
                    <h3>Nieuwe bezoekers</h3>
                    <div class="stats-value" id="firstTimeVisitors">0</div>
                </div>
                
                <div class="stats-card">
                    <h3>Terugkerende bezoekers</h3>
                    <div class="stats-value" id="returningVisitors">0</div>
                </div>
            </div>
            
            <div class="stats-charts">
                <div class="stats-chart" id="genderChart"></div>
                <div class="stats-chart" id="ageGroupChart"></div>
                <div class="stats-chart" id="topMunicipalitiesChart"></div>
                <div class="stats-chart" id="topActivitiesChart"></div>
                <div class="stats-chart" id="attendanceByMonthChart"></div>
            </div>
            
            <div class="btn-group">
                <button id="exportStatsBtn" class="btn-success">Exporteer statistieken</button>
                <button id="printStatsBtn" class="btn-primary">Afdrukken</button>
            </div>
        </div>
            
        <div id="settings" class="tab-content">
            <h2>Instellingen</h2>
            
            <div class="form-group">
                <div class="checkbox-container">
                    <input type="checkbox" id="darkMode">
                    <label for="darkMode">Donkere modus</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="dataStoragePeriod">Bewaartermijn gegevens</label>
                <select id="dataStoragePeriod">
                    <option value="30">30 dagen</option>
                    <option value="90">90 dagen</option>
                    <option value="180">180 dagen</option>
                    <option value="365">1 jaar</option>
                    <option value="730">2 jaar</option>
                    <option value="0">Onbeperkt</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="defaultActivity">Standaard activiteit</label>
                <input type="text" id="defaultActivity">
            </div>
            
            <div class="form-group">
                <label for="defaultTheme">Standaard thema</label>
                <input type="text" id="defaultTheme">
            </div>
            
            <div class="form-group">
                <div class="checkbox-container">
                    <input type="checkbox" id="showVisitCount">
                    <label for="showVisitCount">Toon aantal eerdere bezoeken bij invoer</label>
                </div>
            </div>
            
            <div class="btn-group">
                <button id="clearDataBtn" class="btn-danger">Alle gegevens wissen</button>
                <button id="saveSettingsBtn" class="btn-success">Instellingen opslaan</button>
            </div>
        </div>
        
        <!-- Edit modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Aanwezigheid bewerken</h2>
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label for="editFirstName">Voornaam</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAge">Leeftijd</label>
                        <input type="number" id="editAge" min="0" max="120" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editGender">Geslacht</label>
                        <select id="editGender" required>
                            <option value="M">Man</option>
                            <option value="V">Vrouw</option>
                            <option value="X">Ander/X</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editMunicipality">Gemeente</label>
                        <div class="autocomplete">
                            <input type="text" id="editMunicipality" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editPostalCode">Postcode</label>
                        <input type="text" id="editPostalCode" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editActivity">Activiteit</label>
                        <input type="text" id="editActivity" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editTheme">Thema</label>
                        <input type="text" id="editTheme" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editDate">Datum</label>
                        <input type="date" id="editDate" required>
                    </div>
                    
                    <button type="submit" class="btn-block btn-success">Opslaan</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
        let personRegistry = JSON.parse(localStorage.getItem('personRegistry')) || [];
        let municipalities = JSON.parse(localStorage.getItem('municipalities')) || [];
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            darkMode: false,
            dataStoragePeriod: 365
        };
        
        // DOM Elements
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const registrationForm = document.getElementById('registrationForm');
        const attendanceList = document.getElementById('attendanceList');
        const personSearch = document.getElementById('personSearch');
        const personSearchResults = document.getElementById('personSearchResults');
        const attendanceSearch = document.getElementById('attendanceSearch');
        const importPersonsBtn = document.getElementById('importPersonsBtn');
        const importMunicipalitiesBtn = document.getElementById('importMunicipalitiesBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const darkModeToggle = document.getElementById('darkMode');
        const dataStoragePeriod = document.getElementById('dataStoragePeriod');
        const municipalityInput = document.getElementById('municipality');
        const editMunicipalityInput = document.getElementById('editMunicipality');
        const importStatus = document.getElementById('importStatus');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const closeModal = document.querySelector('.close');
        
        // Initialize app
        function initApp() {
            renderAttendanceList();
            setupTabNavigation();
            setupEventListeners();
            applySettings();
            setupAutoComplete(municipalityInput);
            setupAutoComplete(editMunicipalityInput);
        }
        
        // Tab navigation
        function setupTabNavigation() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // Event listeners
        function setupEventListeners() {
            // Registration form submission
            registrationForm.addEventListener('submit', handleRegistration);
            
            // Person search
            personSearch.addEventListener('input', handlePersonSearch);
            
            // Attendance search
            attendanceSearch.addEventListener('input', filterAttendanceList);
            
            // Import/Export buttons
            importPersonsBtn.addEventListener('click', importPersons);
            importMunicipalitiesBtn.addEventListener('click', importMunicipalities);
            exportBtn.addEventListener('click', exportToExcel);
            
            // Settings buttons
            clearDataBtn.addEventListener('click', confirmClearData);
            saveSettingsBtn.addEventListener('click', saveSettings);
            darkModeToggle.addEventListener('change', toggleDarkMode);
            
            // Modal close
            closeModal.addEventListener('click', () => {
                editModal.style.display = 'none';
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === editModal) {
                    editModal.style.display = 'none';
                }
            });
            
            // Edit form submission
            editForm.addEventListener('submit', handleEdit);
        }
        
        // Handle registration
        function handleRegistration(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now().toString(),
                firstName: document.getElementById('firstName').value,
                age: parseInt(document.getElementById('age').value),
                gender: document.getElementById('gender').value,
                municipality: document.getElementById('municipality').value,
                postalCode: document.getElementById('postalCode').value,
                activity: document.getElementById('activity').value,
                theme: document.getElementById('theme').value,
                date: document.getElementById('date').value,
                timestamp: Date.now()
            };
            
            // Add to attendance data
            attendanceData.push(formData);
            saveAttendanceData();
            
            // Add to person registry if not exists
            const personExists = personRegistry.some(person => 
                person.firstName.toLowerCase() === formData.firstName.toLowerCase() &&
                person.municipality.toLowerCase() === formData.municipality.toLowerCase()
            );
            
            if (!personExists) {
                personRegistry.push({
                    firstName: formData.firstName,
                    age: formData.age,
                    gender: formData.gender,
                    municipality: formData.municipality,
                    postalCode: formData.postalCode,
                    firstVisit: formData.date,
                    visitCount: 1
                });
            } else {
                // Update visit count
                const personIndex = personRegistry.findIndex(person => 
                    person.firstName.toLowerCase() === formData.firstName.toLowerCase() &&
                    person.municipality.toLowerCase() === formData.municipality.toLowerCase()
                );
                
                if (personIndex !== -1) {
                    personRegistry[personIndex].visitCount++;
                    personRegistry[personIndex].age = formData.age; // Update age
                }
            }
            
            savePersonRegistry();
            
            // Reset form
            registrationForm.reset();
            
            // Show success message
            alert('Aanwezigheid succesvol geregistreerd!');
            
            // Refresh attendance list
            renderAttendanceList();
        }
        
        // Handle person search
        function handlePersonSearch() {
            const searchTerm = personSearch.value.toLowerCase();
            
            if (searchTerm.length < 2) {
                personSearchResults.innerHTML = '';
                return;
            }
            
            const matches = personRegistry.filter(person => 
                person.firstName.toLowerCase().includes(searchTerm)
            );
            
            personSearchResults.innerHTML = '';
            
            if (matches.length > 0) {
                const resultsList = document.createElement('div');
                resultsList.classList.add('autocomplete-items');
                
                matches.forEach(person => {
                    const resultItem = document.createElement('div');
                    resultItem.innerHTML = `<strong>${person.firstName}</strong> (${person.age}, ${person.municipality})`;
                    resultItem.addEventListener('click', () => {
                        document.getElementById('firstName').value = person.firstName;
                        document.getElementById('age').value = person.age;
                        document.getElementById('gender').value = person.gender;
                        document.getElementById('municipality').value = person.municipality;
                        document.getElementById('postalCode').value = person.postalCode;
                        personSearch.value = '';
                        personSearchResults.innerHTML = '';
                    });
                    resultsList.appendChild(resultItem);
                });
                
                personSearchResults.appendChild(resultsList);
            }
        }
        
        // Filter attendance list
        function filterAttendanceList() {
            const searchTerm = attendanceSearch.value.toLowerCase();
            renderAttendanceList(searchTerm);
        }
        
        // Render attendance list
        function renderAttendanceList(searchTerm = '') {
            attendanceList.innerHTML = '';
            
            let filteredData = attendanceData;
            
            if (searchTerm) {
                filteredData = attendanceData.filter(entry => 
                    entry.firstName.toLowerCase().includes(searchTerm) ||
                    entry.municipality.toLowerCase().includes(searchTerm) ||
                    entry.date.includes(searchTerm) ||
                    entry.activity.toLowerCase().includes(searchTerm) ||
                    entry.theme.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort by date (newest first)
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredData.forEach(entry => {
                const row = document.createElement('tr');
                
                const formatDate = (dateStr) => {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('nl-BE');
                };
                
                row.innerHTML = `
                    <td>${formatDate(entry.date)}</td>
                    <td>${entry.firstName}</td>
                    <td>${entry.age}</td>
                    <td>${entry.gender}</td>
                    <td>${entry.municipality}</td>
                    <td>${entry.postalCode}</td>
                    <td>${entry.activity}</td>
                    <td>${entry.theme}</td>
                    <td>
                        <button class="btn-warning edit-btn" data-id="${entry.id}">Bewerken</button>
                        <button class="btn-danger delete-btn" data-id="${entry.id}">Verwijderen</button>
                    </td>
                `;
                
                attendanceList.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-id');
                    openEditModal(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-id');
                    deleteAttendance(id);
                });
            });
        }
        
        // Open edit modal
        function openEditModal(id) {
            const entry = attendanceData.find(item => item.id === id);
            
            if (entry) {
                document.getElementById('editId').value = entry.id;
                document.getElementById('editFirstName').value = entry.firstName;
                document.getElementById('editAge').value = entry.age;
                document.getElementById('editGender').value = entry.gender;
                document.getElementById('editMunicipality').value = entry.municipality;
                document.getElementById('editPostalCode').value = entry.postalCode;
                document.getElementById('editActivity').value = entry.activity;
                document.getElementById('editTheme').value = entry.theme;
                document.getElementById('editDate').value = entry.date;
                
                editModal.style.display = 'flex';
            }
        }
        
        // Handle edit submission
        function handleEdit(e) {
            e.preventDefault();
            
            const id = document.getElementById('editId').value;
            const index = attendanceData.findIndex(item => item.id === id);
            
            if (index !== -1) {
                const oldEntry = attendanceData[index];
                
                attendanceData[index] = {
                    ...oldEntry,
                    firstName: document.getElementById('editFirstName').value,
                    age: parseInt(document.getElementById('editAge').value),
                    gender: document.getElementById('editGender').value,
                    municipality: document.getElementById('editMunicipality').value,
                    postalCode: document.getElementById('editPostalCode').value,
                    activity: document.getElementById('editActivity').value,
                    theme: document.getElementById('editTheme').value,
                    date: document.getElementById('editDate').value
                };
                
                saveAttendanceData();
                renderAttendanceList();
                editModal.style.display = 'none';
                
                // Update person registry
                updatePersonRegistry(oldEntry, attendanceData[index]);
            }
        }
        
        // Delete attendance
        function deleteAttendance(id) {
            if (confirm('Weet u zeker dat u deze aanwezigheid wilt verwijderen?')) {
                const index = attendanceData.findIndex(item => item.id === id);
                
                if (index !== -1) {
                    const deletedEntry = attendanceData[index];
                    attendanceData.splice(index, 1);
                    saveAttendanceData();
                    renderAttendanceList();
                    
                    // Update person registry
                    updatePersonRegistryAfterDelete(deletedEntry);
                }
            }
        }
        
        // Update person registry
        function updatePersonRegistry(oldEntry, newEntry) {
            // Only update if name or municipality changed
            if (oldEntry.firstName !== newEntry.firstName || oldEntry.municipality !== newEntry.municipality) {
                // Decrease visit count for old entry
                const oldPersonIndex = personRegistry.findIndex(person => 
                    person.firstName.toLowerCase() === oldEntry.firstName.toLowerCase() &&
                    person.municipality.toLowerCase() === oldEntry.municipality.toLowerCase()
                );
                
                if (oldPersonIndex !== -1) {
                    personRegistry[oldPersonIndex].visitCount--;
                    
                    // Remove person if visit count is 0
                    if (personRegistry[oldPersonIndex].visitCount <= 0) {
                        personRegistry.splice(oldPersonIndex, 1);
                    }
                }
                
                // Increase visit count for new entry or add new person
                const newPersonIndex = personRegistry.findIndex(person => 
                    person.firstName.toLowerCase() === newEntry.firstName.toLowerCase() &&
                    person.municipality.toLowerCase() === newEntry.municipality.toLowerCase()
                );
                
                if (newPersonIndex !== -1) {
                    personRegistry[newPersonIndex].visitCount++;
                    personRegistry[newPersonIndex].age = newEntry.age; // Update age
                } else {
                    personRegistry.push({
                        firstName: newEntry.firstName,
                        age: newEntry.age,
                        gender: newEntry.gender,
                        municipality: newEntry.municipality,
                        postalCode: newEntry.postalCode,
                        firstVisit: newEntry.date,
                        visitCount: 1
                    });
                }
            } else {
                // Update age if it changed
                const personIndex = personRegistry.findIndex(person => 
                    person.firstName.toLowerCase() === newEntry.firstName.toLowerCase() &&
                    person.municipality.toLowerCase() === newEntry.municipality.toLowerCase()
                );
                
                if (personIndex !== -1) {
                    personRegistry[personIndex].age = newEntry.age;
                }
            }
            
            savePersonRegistry();
        }
        
        // Update person registry after delete
        function updatePersonRegistryAfterDelete(deletedEntry) {
            const personIndex = personRegistry.findIndex(person => 
                person.firstName.toLowerCase() === deletedEntry.firstName.toLowerCase() &&
                person.municipality.toLowerCase() === deletedEntry.municipality.toLowerCase()
            );
            
            if (personIndex !== -1) {
                personRegistry[personIndex].visitCount--;
                
                // Remove person if visit count is 0
                if (personRegistry[personIndex].visitCount <= 0) {
                    personRegistry.splice(personIndex, 1);
                }
                
                savePersonRegistry();
            }
        }
        
        // Import persons
        function importPersons() {
            const fileInput = document.getElementById('importPersonsFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showImportStatus('Selecteer eerst een bestand.', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const csvData = e.target.result;
                processPersonsCSV(csvData);
            };
            
            reader.onerror = () => {
                showImportStatus('Fout bij het lezen van het bestand.', 'error');
            };
            
            reader.readAsText(file);
        }
        
        // Process persons CSV
        function processPersonsCSV(csvData) {
            // Parse CSV
            const rows = csvData.split('\n');
            const headers = rows[0].split(',').map(header => header.trim());
            
            // Validate headers
            const requiredHeaders = ['Naam', 'Leeftijd', 'Geslacht', 'Gemeente', 'Postcode'];
            const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
            
            if (missingHeaders.length > 0) {
                showImportStatus(`Ontbrekende kolommen in CSV: ${missingHeaders.join(', ')}`, 'error');
                return;
            }
            
            const nameIndex = headers.indexOf('Naam');
            const ageIndex = headers.indexOf('Leeftijd');
            const genderIndex = headers.indexOf('Geslacht');
            const municipalityIndex = headers.indexOf('Gemeente');
            const postalCodeIndex = headers.indexOf('Postcode');
            
            const importedPersons = [];
            
            // Process data rows
            for (let i = 1; i < rows.length; i++) {
                if (!rows[i].trim()) continue;
                
                const columns = rows[i].split(',').map(col => col.trim());
                
                if (columns.length !== headers.length) {
                    console.warn(`Regel ${i} heeft niet het juiste aantal kolommen en wordt overgeslagen.`);
                    continue;
                }
                
                const person = {
                    firstName: columns[nameIndex],
                    age: parseInt(columns[ageIndex]),
                    gender: columns[genderIndex],
                    municipality: columns[municipalityIndex],
                    postalCode: columns[postalCodeIndex],
                    firstVisit: new Date().toISOString().split('T')[0],
                    visitCount: 0
                };
                
                if (!isNaN(person.age) && person.firstName && person.gender && person.municipality && person.postalCode) {
                    importedPersons.push(person);
                }
            }
            
            // Add to person registry
            let newPersonCount = 0;
            
            importedPersons.forEach(importedPerson => {
                const personExists = personRegistry.some(person => 
                    person.firstName.toLowerCase() === importedPerson.firstName.toLowerCase() &&
                    person.municipality.toLowerCase() === importedPerson.municipality.toLowerCase()
                );
                
                if (!personExists) {
                    personRegistry.push(importedPerson);
                    newPersonCount++;
                }
            });
            
            savePersonRegistry();
            showImportStatus(`${newPersonCount} nieuwe personen geïmporteerd.`, 'success');
        }
        
        // Import municipalities
        function importMunicipalities() {
            const fileInput = document.getElementById('importMunicipalitiesFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showImportStatus('Selecteer eerst een bestand.', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const csvData = e.target.result;
                processMunicipalitiesCSV(csvData);
            };
            
            reader.onerror = () => {
                showImportStatus('Fout bij het lezen van het bestand.', 'error');
            };
            
            reader.readAsText(file);
        }
        
        // Process municipalities CSV
        function processMunicipalitiesCSV(csvData) {
            // Parse CSV
            const rows = csvData.split('\n');
            const headers = rows[0].split(',').map(header => header.trim());
            
            // Validate headers
            const requiredHeaders = ['Gemeente', 'Postcode'];
            const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
            
            if (missingHeaders.length > 0) {
                showImportStatus(`Ontbrekende kolommen in CSV: ${missingHeaders.join(', ')}`, 'error');
                return;
            }
            
            const municipalityIndex = headers.indexOf('Gemeente');
            const postalCodeIndex = headers.indexOf('Postcode');
            
            municipalities = [];
            
            // Process data rows
            for (let i = 1; i < rows.length; i++) {
                if (!rows[i].trim()) continue;
                
                const columns = rows[i].split(',').map(col => col.trim());
                
                if (columns.length !== headers.length) {
                    console.warn(`Regel ${i} heeft niet het juiste aantal kolommen en wordt overgeslagen.`);
                    continue;
                }
                
                const municipality = {
                    name: columns[municipalityIndex],
                    postalCode: columns[postalCodeIndex]
                };
                
                if (municipality.name && municipality.postalCode) {
                    municipalities.push(municipality);
                }
            }
            
            saveMunicipalities();
            setupAutoComplete(municipalityInput);
            setupAutoComplete(editMunicipalityInput);
            showImportStatus(`${municipalities.length} gemeenten geïmporteerd.`, 'success');
        }
        
        // Export to Excel (CSV)
        function exportToExcel() {
            // Generate CSV content
            let csvContent = 'Datum,Aantal aanwezigheden,Naam,Geslacht,Leeftijd,Postcode,Activiteit,Thema\n';
            
            // Group by date and activity
            const groupedData = {};
            
            attendanceData.forEach(entry => {
                const key = `${entry.date}_${entry.activity}_${entry.theme}`;
                
                if (!groupedData[key]) {
                    groupedData[key] = {
                        date: entry.date,
                        activity: entry.activity,
                        theme: entry.theme,
                        attendees: []
                    };
                }
                
                groupedData[key].attendees.push(entry);
            });
            
            // Convert to CSV rows
            Object.values(groupedData).forEach(group => {
                const formatDate = (dateStr) => {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('nl-BE');
                };
                
                group.attendees.forEach(attendee => {
                    const isNewAttendee = isFirstVisit(attendee);
                    const visitLabel = isNewAttendee ? 'NIEUW' : '';
                    
                    csvContent += `${formatDate(group.date)},${group.attendees.length},"${attendee.firstName} ${visitLabel}",${attendee.gender},${attendee.age},${attendee.postalCode},${group.activity},${group.theme}\n`;
                });
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `aanwezigheden_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Check if this is the first visit
        function isFirstVisit(attendee) {
            const visits = attendanceData.filter(entry => 
                entry.firstName.toLowerCase() === attendee.firstName.toLowerCase() &&
                entry.municipality.toLowerCase() === attendee.municipality.toLowerCase()
            );
            
            // Sort by date
            visits.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Check if this is the first visit
            return visits.length > 0 && visits[0].id === attendee.id;
        }
        
        // Show import status
        function showImportStatus(message, type) {
            importStatus.textContent = message;
            importStatus.className = 'status-message ' + type;
            
            // Clear after 5 seconds
            setTimeout(() => {
                importStatus.textContent = '';
                importStatus.className = 'status-message';
            }, 5000);
        }
        
        // Confirm clear data
        function confirmClearData() {
            if (confirm('Weet u zeker dat u alle gegevens wilt wissen? Dit kan niet ongedaan worden gemaakt!')) {
                attendanceData = [];
                personRegistry = [];
                
                saveAttendanceData();
                savePersonRegistry();
                renderAttendanceList();
                
                alert('Alle gegevens zijn gewist.');
            }
        }
        
        // Save settings
        function saveSettings() {
            settings.dataStoragePeriod = parseInt(dataStoragePeriod.value);
            
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('Instellingen opgeslagen.');
            
            // Apply data retention policy
            applyDataRetentionPolicy();
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            settings.darkMode = darkModeToggle.checked;
            localStorage.setItem('settings', JSON.stringify(settings));
            applyDarkMode();
        }
        
        // Apply settings
        function applySettings() {
            // Dark mode
            darkModeToggle.checked = settings.darkMode;
            applyDarkMode();
            
            // Data storage period
            dataStoragePeriod.value = settings.dataStoragePeriod;
            
            // Apply data retention policy
            applyDataRetentionPolicy();
        }
        
        // Apply dark mode
        function applyDarkMode() {
            if (settings.darkMode) {
                document.documentElement.style.setProperty('--primary-color', '#6a89cc');
                document.documentElement.style.setProperty('--secondary-color', '#4a69bd');
                document.documentElement.style.setProperty('--light-color', '#222f3e');
                document.body.style.backgroundColor = '#1e272e';
                document.body.style.color = '#f5f6fa';
            } else {
                document.documentElement.style.setProperty('--primary-color', '#4a6fa5');
                document.documentElement.style.setProperty('--secondary-color', '#2c3e50');
                document.documentElement.style.setProperty('--light-color', '#f5f5f5');
                document.body.style.backgroundColor = '#f0f2f5';
                document.body.style.color = '#333';
            }
        }
        
        // Apply data retention policy
        function applyDataRetentionPolicy() {
            const retentionDays = settings.dataStoragePeriod;
            
            if (retentionDays > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
                
                // Filter attendance data
                attendanceData = attendanceData.filter(entry => {
                    const entryDate = new Date(entry.timestamp);
                    return entryDate >= cutoffDate;
                });
                
                saveAttendanceData();
                
                // Update person registry
                updatePersonRegistryFromAttendance();
                
                renderAttendanceList();
            }
        }
        
        // Update person registry from attendance
        function updatePersonRegistryFromAttendance() {
            // Reset person registry
            personRegistry = [];
            
            // Rebuild from attendance data
            attendanceData.forEach(entry => {
                const personIndex = personRegistry.findIndex(person => 
                    person.firstName.toLowerCase() === entry.firstName.toLowerCase() &&
                    person.municipality.toLowerCase() === entry.municipality.toLowerCase()
                );
                
                if (personIndex !== -1) {
                    personRegistry[personIndex].visitCount++;
                    
                    // Update first visit if earlier
                    if (new Date(entry.date) < new Date(personRegistry[personIndex].firstVisit)) {
                        personRegistry[personIndex].firstVisit = entry.date;
                    }
                } else {
                    personRegistry.push({
                        firstName: entry.firstName,
                        age: entry.age,
                        gender: entry.gender,
                        municipality: entry.municipality,
                        postalCode: entry.postalCode,
                        firstVisit: entry.date,
                        visitCount: 1
                    });
                }
            });
            
            savePersonRegistry();
        }
        
        // Setup autocomplete for municipalities
        function setupAutoComplete(input) {
            if (!input) return;
            
            // Autocomplete function
            function autocomplete(inp, arr) {
                let currentFocus;
                
                // Execute when someone writes in the text field
                inp.addEventListener("input", function(e) {
                    let a, b, i, val = this.value;
                    closeAllLists();
                    
                    if (!val) return false;
                    currentFocus = -1;
                    
                    // Create a DIV element that will contain the items
                    a = document.createElement("DIV");
                    a.setAttribute("id", this.id + "autocomplete-list");
                    a.setAttribute("class", "autocomplete-items");
                    
                    // Append the DIV element as a child of the autocomplete container
                    this.parentNode.appendChild(a);
                    
                    // For each item in the array
                    for (i = 0; i < arr.length; i++) {
                        // Check if the item starts with the same letters as the text field value
                        if (arr[i].name.substr(0, val.length).toUpperCase() === val.toUpperCase() ||
                            arr[i].postalCode.substr(0, val.length) === val) {
                            
                            // Create a DIV element for each matching element
                            b = document.createElement("DIV");
                            b.innerHTML = `<strong>${arr[i].name}</strong> (${arr[i].postalCode})`;
                            
                            // Insert an input field that will hold the current array item's value
                            b.innerHTML += `<input type='hidden' value='${arr[i].name}'>`;
                            b.innerHTML += `<input type='hidden' class='postal-code' value='${arr[i].postalCode}'>`;
                            
                            // Execute when someone clicks on the item value
                            b.addEventListener("click", function(e) {
                                // Insert the value for the autocomplete text field
                                inp.value = this.getElementsByTagName("input")[0].value;
                                
                                // Set postal code
                                const postalCode = this.getElementsByClassName("postal-code")[0].value;
                                
                                if (inp.id === 'municipality') {
                                    document.getElementById('postalCode').value = postalCode;
                                } else if (inp.id === 'editMunicipality') {
                                    document.getElementById('editPostalCode').value = postalCode;
                                }
                                
                                // Close the list of autocompleted values
                                closeAllLists();
                            });
                            a.appendChild(b);
                        }
                    }
                });
                
                // Execute a function presses a key on the keyboard
                inp.addEventListener("keydown", function(e) {
                    let x = document.getElementById(this.id + "autocomplete-list");
                    if (x) x = x.getElementsByTagName("div");
                    
                    if (e.keyCode === 40) {
                        // Arrow DOWN
                        currentFocus++;
                        addActive(x);
                    } else if (e.keyCode === 38) {
                        // Arrow UP
                        currentFocus--;
                        addActive(x);
                    } else if (e.keyCode === 13) {
                        // ENTER key
                        e.preventDefault();
                        if (currentFocus > -1) {
                            if (x) x[currentFocus].click();
                        }
                    }
                });
                
                // Classify an item as "active"
                function addActive(x) {
                    if (!x) return false;
                    removeActive(x);
                    if (currentFocus >= x.length) currentFocus = 0;
                    if (currentFocus < 0) currentFocus = (x.length - 1);
                    x[currentFocus].classList.add("autocomplete-active");
                }
                
                // Remove the "active" class from all autocomplete items
                function removeActive(x) {
                    for (let i = 0; i < x.length; i++) {
                        x[i].classList.remove("autocomplete-active");
                    }
                }
                
                // Close all autocomplete lists in the document
                function closeAllLists(elmnt) {
                    const x = document.getElementsByClassName("autocomplete-items");
                    for (let i = 0; i < x.length; i++) {
                        if (elmnt !== x[i] && elmnt !== inp) {
                            x[i].parentNode.removeChild(x[i]);
                        }
                    }
                }
                
                // Close the list when someone clicks in the document
                document.addEventListener("click", function(e) {
                    closeAllLists(e.target);
                });
            }
            
            // Initialize autocomplete
            autocomplete(input, municipalities);
        }
        
        // Save data to localStorage
        function saveAttendanceData() {
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
        }
        
        function savePersonRegistry() {
            localStorage.setItem('personRegistry', JSON.stringify(personRegistry));
        }
        
        function saveMunicipalities() {
            localStorage.setItem('municipalities', JSON.stringify(municipalities));
        }
        
        // Add default municipalities if none exist
        function addDefaultMunicipalities() {
            if (municipalities.length === 0) {
                municipalities = [
                    { name: 'Antwerpen', postalCode: '2000' },
                    { name: 'Gent', postalCode: '9000' },
                    { name: 'Brugge', postalCode: '8000' },
                    { name: 'Leuven', postalCode: '3000' },
                    { name: 'Hasselt', postalCode: '3500' },
                    { name: 'Brussel', postalCode: '1000' },
                    { name: 'Mechelen', postalCode: '2800' },
                    { name: 'Aalst', postalCode: '9300' },
                    { name: 'Kortrijk', postalCode: '8500' },
                    { name: 'Oostende', postalCode: '8400' }
                ];
                saveMunicipalities();
            }
        }
        
        // Service worker for offline capabilities
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker geregistreerd:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registratie mislukt:', error);
                    });
            }
        }
        
        // Initialize app
        addDefaultMunicipalities();
        initApp();
        registerServiceWorker();
    </script>
</body>
</html>